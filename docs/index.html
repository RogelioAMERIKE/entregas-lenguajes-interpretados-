<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>AXOLOTL PANIC - DELUXE EDITION</title>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(110deg, #fae3e3 0%, #e5f2ff 100%);
      margin:0; padding:0;
      color: #176778;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    .visible {display:block;}
    .hidden {display:none;}
    /* Menú principal */
    .menu-container {
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .main-title {
      font-size: 3em;
      font-weight: bold;
      color: #219ebc;
      text-align: center;
      margin-bottom: 65px;
      letter-spacing:2px;
      margin-top:8vh;
      text-shadow: 0 3px 15px #efffff77;
    }
    .main-menu-btn {
      font-size:1.3em;
      font-weight:600;
      background: #219ebc;
      color:#fff;
      padding: 18px 0;
      width:350px;
      max-width:95vw;
      border:none;
      border-radius: 15px;
      margin:0 0 17px 0;
      cursor:pointer;
      box-shadow:0 2px 11px #17809933;
      transition:background .2s,transform .15s;
      letter-spacing:1px;
      display:block;
    }
    .main-menu-btn:hover {background:#126784;transform:scale(1.04);}
    /* Secciones generales */
    .section {display:none;}
    /* Estilos de juego horizontal */
    .container {
      min-height:100vh;
      align-items:center;
    }
    .header-bar {
      width:100%;
      background:rgba(255,255,255,0.8);
      padding:18px 28px 12px 32px;
      font-size:2em;
      font-weight: bold;
      color:#219ebc;
      box-shadow:0 3px 18px #cbeaed88;
      margin-bottom:8px;
      letter-spacing: 2px;
    }
    .game-layout {
      display:flex;
      flex-direction:row;
      width:100%;
      max-width:1600px;
      margin:auto;
      min-height:660px;
      box-sizing:border-box;
    }
    .side-panel {
      width:220px;
      min-width:180px;
      margin-top:25px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .player-box {
      background:#fff;
      border-radius:16px;
      border:2.5px solid #c7e9ff;
      padding:18px 12px;
      margin-bottom:8px;
      box-shadow:0 2px 10px #e6ebee2d;
      font-size:1.08em;
    }
    .active-player {border:2.5px solid #ee4cb7;}
    .you {border-color:#ee88cb;background:#fdccec;}
    .bot-box {background:#f4edff;}
    .main-panel {
      flex:1;
      margin:28px 18px;
      background:rgba(255,255,255,0.6);
      border-radius:22px;
      box-shadow:0 6px 32px #c1d8eaaa;
      padding:35px 23px 45px 23px;
      display:flex;
      flex-direction:column;
      min-width:360px;
      justify-content:flex-start;
    }
    .gamebar {
      display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;
    }
    .turn-indicator {font-size:1.16em;font-weight:bold;color:#b8277b;}
    .btn {
      font-size:1em;
      font-weight:600;
      background: #219ebc;
      color:#fff;
      padding:14px 36px;
      border: none;
      border-radius: 14px;
      margin: 9px 0 11px 0;
      cursor:pointer;
      box-shadow:0 2px 22px #17809935;
      transition:background .17s,transform .17s;
      letter-spacing:.7px;
      min-width:175px;
    }
    .btn-light {background: #dfedd1; color: #219ebc;}
    .btn-menu {background:#ffbaba;color:#4c4c4c;min-width:120px;}
    .btn-exit {background:#dfabb4;color:#fff;font-size:1em;padding:6px 17px;border-radius:11px;}
    .cards-panel {
      margin:20px 0;
      background:#faffed;
      border-radius:14px;
      padding:17px;
      min-height:52px;
      box-shadow:0 1px 8px #c9d2c345;
    }
    .card-saved {background:#fff6e7;border:2px solid #f9f86a;padding:8px 15px;border-radius:7px;cursor:pointer;display:inline-block;margin:7px 6px;font-weight:bold;}
    .card-saved:hover {background:#f9f86a;}
    .fichas-row {display:flex;flex-wrap:wrap;gap:9px;margin:22px 0;}
    .ficha-circle {width:38px;height:38px;border-radius:50%;background:#bbb;box-shadow:0 0 4px #ceceef;display:flex;align-items:center;justify-content:center;font-size:1em;cursor:pointer;}
    .fichaRosa {background:#ee4cb7;}
    .fichaCafe {background:#bc8c4b;}
    .fichaAmarilla {background:#f9f86a;}
    .store-modal, .modal-overlay {position:fixed;top:0;left:0;right:0;bottom:0;z-index:95;background:#fff9eccc;backdrop-filter:blur(2.5px);display:none;align-items:center;justify-content:center;}
    .store-content, .modal-content {background:#fff;padding:23px 28px 28px 28px;border-radius:13px;max-width:370px;box-shadow:0 0 12px #fbee8c99;}
    .store-item {margin:14px 0;padding:13px;background:#eee;border-radius:12px;}
    .store-item b {display:block;margin-bottom:6px;color:#219ebc;}
    .store-item-desc {font-size:0.94em;color:#666;margin:5px 0;}
    .btn-store {background:#b5f8cb;}
    .modal-buttons {display:flex;gap:12px;justify-content:center;margin-top:20px;}
    .modal-buttons button {padding:8px 16px;font-size:1em;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
    .btn-aceptar {background:#6be5f6;color:#fff;}
    .btn-cancelar {background:#ff6b6b;color:#fff;}
    .btn-aceptar:hover {background:#48a8c8;}
    .btn-cancelar:hover {background:#d63031;}
    .ranking-list {padding:0;}
    .ranking-list li {list-style:none;font-size:1.1em;margin:8px 2px;}
    .dialog {background:#fff4fa;color:#bc6c98;border-radius:9px;padding:8px 13px;font-size:1em;margin:9px 0;}
    .creditstxt, .tutorialtxt {padding:1em 0.6em;}
    .title-section {font-weight:bold;font-size:1.16em;}
    @media (max-width:1000px){
      .game-layout{flex-direction:column;}
      .side-panel{flex-direction:row;width:100%;min-width:0;max-width:98vw;justify-content:center;gap:8px;margin-bottom:0;}
      .main-panel{margin:12px 2vw;}
    }
    @media (max-width:700px){
      .container{padding:0;}
      .header-bar{font-size:1.2em;padding:15px 6px 8px 12px;}
      .main-panel{flex:1;padding:13px 3vw;}
      .gamebar{flex-direction:column;}
      .turn-indicator{margin-bottom:7px;}
      .btn, .btn-light{font-size:0.89em;}
      .side-panel{font-size:.92em;}
      .main-title{font-size:2em;width:96vw;}
      .main-menu-btn{width:96vw;font-size:1em;}
    }
  </style>
</head>
<body>
  <!-- Menu principal -->
  <div id="mainMenu" class="menu-container visible">
    <div class="main-title">AXOLOTL PANIC<br>DELUXE EDITION</div>
    <button class="main-menu-btn" onclick="switchSection('game')">JUGAR</button>
    <button class="main-menu-btn" onclick="switchSection('tutorial')">TUTORIAL</button>
    <button class="main-menu-btn" onclick="switchSection('credits')">CRÉDITOS</button>
    <button class="main-menu-btn" onclick="if(confirm('¿Salir del juego?')) window.close()">SALIR</button>
  </div>
  <!-- Sección juego -->
  <div id="gameSection" class="container hidden">
    <div class="header-bar">AXOLOTL PANIC</div>
    <div class="game-layout" id="gameLayout">
      <div class="side-panel" id="sidePanel"></div>
      <div class="main-panel" id="mainPanel">
        <div class="gamebar">
          <div id="turnIndicator" class="turn-indicator"></div>
          <button class="btn-exit" onclick="switchSection('menu')">Salir al Menú</button>
        </div>
        <div class="btn-group">
          <button id="recogerCartaBtn" class="btn" style="display:none;">Recoger Carta Nueva</button>
          <button id="tiendaBtn" class="btn btn-light">Ir a La Tiendita</button>
        </div>
        <div class="cards-panel">
          <b>Tus Cartas (<span id="nCartas"></span>/5)</b>
          <div id="cartasAlmacenadas"></div>
        </div>
        <div class="btn-group" style="margin-bottom:10px;">
          <button id="aplicarCartaBtn" class="btn btn-light" style="display:none;">Aplicar Carta Nueva</button>
          <button id="almacenarCartaBtn" class="btn btn-menu" style="display:none;">Almacenar Carta Nueva</button>
          <button id="finalizarTurnoBtn" class="btn" style="display:none;">Finalizar Turno</button>
        </div>
        <div style="margin:20px 0 10px 0;font-weight:bold; color:#176778;">Fichas de Ajolotes</div>
        <div class="fichas-row" id="fichasCirculares"></div>
        <div id="turnDialog" class="dialog" style="display:none"></div>
        <div id="storeModal" class="store-modal">
          <div class="store-content">
            <button class="btn-exit" onclick="closeStore()">Cerrar Tienda</button>
            <h3 style="text-align:center;color:#219ebc;">La Tiendita</h3>
            <p style="text-align:center;font-size:0.97em;color:#666;">Gasta basura para comprar puntos</p>
            <div id="storeItems"></div>
          </div>
        </div>
        <div id="fichaSeleccionModal" class="modal-overlay">
          <div class="modal-content">
            <h3 style="text-align:center;color:#219ebc;">Selecciona una Ficha</h3>
            <p style="text-align:center;color:#666;">Haz clic en una ficha gris para seleccionarla</p>
            <div class="fichas-row" id="fichasSelectModal"></div>
            <div class="modal-buttons">
              <button class="btn-aceptar" onclick="aceptarFichaSeleccionada()">Aceptar</button>
              <button class="btn-cancelar" onclick="cancelarSeleccionFicha()">Cancelar</button>
            </div>
          </div>
        </div>
        <div id="ranking" style="display:none;padding-top:30px;">
          <h2 style="color:#219ebc;font-size:2em;">¡Fin del Juego!</h2>
          <ul class="ranking-list" id="rankingList"></ul>
          <button class="btn" onclick="switchSection('menu')">Volver al Menú</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Tutorial -->
  <div id="tutorialSection" class="section hidden">
    <button class="main-menu-btn" onclick="switchSection('menu')">← Volver al Menú</button>
    <div class="title-section">Tutorial</div>
    <div class="tutorialtxt">Aquí va el texto editable del tutorial.</div>
  </div>
  <!-- Créditos -->
  <div id="creditsSection" class="section hidden">
    <button class="main-menu-btn" onclick="switchSection('menu')">← Volver al Menú</button>
    <div class="title-section">Créditos</div>
    <div class="creditstxt">Equipo de desarrollo...</div>
  </div>

  <script>
    // Navegación entre secciones
    function switchSection(sec) {
      document.getElementById('mainMenu').classList.add('hidden');
      document.getElementById('gameSection').classList.add('hidden');
      document.getElementById('tutorialSection').classList.add('hidden');
      document.getElementById('creditsSection').classList.add('hidden');
      if(sec==="menu") document.getElementById('mainMenu').classList.remove('hidden');
      if(sec==="game") {document.getElementById('gameSection').classList.remove('hidden');initGame();}
      if(sec==="tutorial") document.getElementById('tutorialSection').classList.remove('hidden');
      if(sec==="credits") document.getElementById('creditsSection').classList.remove('hidden');
    }
    // ---- GAMEPLAY LOGIC ----
    // Variables de juego
    const jugadoresBase = [
      { nombre:"Tu", tipo:"humano" },
      { nombre:"Bot 1", tipo:"bot" },
      { nombre:"Bot 2", tipo:"bot" },
      { nombre:"Bot 3", tipo:"bot" }
    ];
    const fichasBase = [
      {color:'rosado',valor:0.5}, {color:'café',valor:1},
      {color:'amarillo',valor:1.5}, {color:'rosado',valor:0.5},
      {color:'café',valor:1}, {color:'amarillo',valor:1.5},
      {color:'rosado',valor:0.5}, {color:'café',valor:1},
      {color:'amarillo',valor:1.5}, {color:'rosado',valor:0.5},
      {color:'café',valor:1}, {color:'amarillo',valor:1.5},
    ];
    const cartasBasura = [
      {tipo:'basura',descripcion:'Basura +1',valor:1},
      {tipo:'basura',descripcion:'Basura +2',valor:2},
      {tipo:'basura',descripcion:'Basura +3',valor:3}
    ];
    const cartasEspeciales = [
      {tipo:'especial',descripcion:'Robo-Basura'},
      {tipo:'especial',descripcion:'Hora de Pescar'}
    ];
    const cartasComodinReto = [
      {tipo:'comodin_reto',descripcion:'Intercambio de Ajolotes'},
      {tipo:'comodin_reto',descripcion:'Duelo de Perder Turno'}
    ];
    const cartasComodinEvento = [
      {tipo:'comodin_evento',descripcion:'Rotación de Basura'},
      {tipo:'comodin_evento',descripcion:'Cambio de Rotación de Turnos'}
    ];
    const tiendaObjetos = [
      {nombre:'Objeto 1', costo:3, puntos:1},
      {nombre:'Objeto 2', costo:6, puntos:2},
      {nombre:'Objeto 3', costo:10, puntos:4}
    ];
    const tiempoLimiteTurno = 8;
    const tiempoBotTurno = 5;
    let jugadores, fichas, cartasMain, turnoActual, turnosTotales, maxCartasAlmacenadas=5, sentidoGiro=1, timerRef, juegoEnCurso=false, cartaActual=null, rankingDone=false;
    let fichaSeleccionadaIdx = null;
    let esperandoSeleccionFicha = false;

    // INICIO DE JUEGO
    function initGame(){
      jugadores = JSON.parse(JSON.stringify(jugadoresBase));
      for (let j of jugadores) {
        j.basura=0;j.puntaje=0;j.fichas=[];j.cartas=[];j.turnosPerdidos=0;
      }
      fichas = shuffleArray([...fichasBase]);
      cartasMain = shuffleArray([
        ...cartasBasura,...cartasBasura,...cartasEspeciales,...cartasEspeciales,
        ...cartasComodinReto,...cartasComodinEvento
      ]);
      turnoActual = sortTurnos();
      turnosTotales = 0;
      sentidoGiro = 1;
      juegoEnCurso=true;
      cartaActual=null;
      fichaSeleccionadaIdx = null;
      esperandoSeleccionFicha = false;
      document.getElementById('ranking').style.display='none';
      updateUI();
      doTurno();
    }

    // UI principal
    function updateUI(){
      // Panel lateral de jugadores
      let sidePanel = document.getElementById('sidePanel');
      sidePanel.innerHTML = "";
      jugadores.forEach((j,idx)=>{
        let classes = ['player-box'];
        if(j.tipo=='bot') classes.push('bot-box');
        if(turnoActual===idx && juegoEnCurso) classes.push('active-player');
        if(idx==0) classes.push('you');
        sidePanel.innerHTML += `<div class="${classes.join(' ')}">
            <b>${j.nombre}</b>
            <div>Basura: ${j.basura}</div>
            <div>Puntaje: ${j.puntaje}</div>
            <div>Fichas: ${j.fichas.map(f=>f.valor).join(', ')||'0'}</div>
            <div>Cartas: ${j.cartas.length}</div>
        </div>`;
      });
      document.getElementById("nCartas").textContent = jugadores[turnoActual].cartas.length;
      let cartasArea = document.getElementById('cartasAlmacenadas');
      cartasArea.innerHTML="";
      if (jugadores[turnoActual].tipo=='humano' && jugadores[turnoActual].cartas.length > 0) {
        jugadores[turnoActual].cartas.forEach((carta,i)=>{
          cartasArea.innerHTML+= `<span class="card-saved" onclick="usarCartaAlmacenada(${i})" title="Click para usar">${carta.descripcion}</span>`;
        });
      } else if(jugadores[turnoActual].tipo=='humano') {
        cartasArea.innerHTML = "<span style='color:#aaaa44;font-weight:bold;'>No tienes cartas almacenadas aún.</span>";
      }
      let fichasRow = document.getElementById('fichasCirculares');
      fichasRow.innerHTML="";
      fichas.forEach((f,i)=>{
        let colorclass = f.revealed ? (f.color=='rosado'?'fichaRosa':(f.color=='café'?'fichaCafe':'fichaAmarilla')) : '';
        fichasRow.innerHTML+= `<div class="ficha-circle ${colorclass}"></div>`;
      });
      document.getElementById('turnIndicator').innerHTML = `Turno de: <span style="color:#ee4cb7;font-weight:bold">${jugadores[turnoActual].nombre}</span>`;
    }

    function showTurnDialog(msg) {
      let dlg=document.getElementById('turnDialog');
      dlg.innerHTML=msg; dlg.style.display="block";
      setTimeout(()=>{dlg.style.display="none";},2400);
    }

    function doTurno(){
      if(!juegoEnCurso) return;
      updateUI();
      document.getElementById('recogerCartaBtn').style.display='none';
      document.getElementById('aplicarCartaBtn').style.display='none';
      document.getElementById('almacenarCartaBtn').style.display='none';
      document.getElementById('finalizarTurnoBtn').style.display='none';
      let jugador=jugadores[turnoActual];
      if(jugador.turnosPerdidos>0){
        jugador.turnosPerdidos--;
        showTurnDialog(jugador.nombre+" perdió su turno.");
        setTimeout(siguienteTurno, 1600); return;
      }
      if(jugador.tipo=='humano'){
        document.getElementById('recogerCartaBtn').style.display='inline-block';
      }else{
        timerRef = setTimeout(()=>{botTurn(jugador)},tiempoBotTurno*1000);
      }
    }

    // BOT DECISIONES
    function botTurn(j){
      let acciones = [];
      if(j.cartas.length<maxCartasAlmacenadas) acciones.push('almacenar');
      acciones.push('aplicar');
      let comprarTienda = (j.basura>=tiendaObjetos[2].costo)&&(j.puntaje<jugadores[0].puntaje);
      let usarCartaEspecial = j.cartas.some(c=>c.tipo==='especial') && (j.puntaje < Math.max(...jugadores.map(x=>x.puntaje)));
      if(comprarTienda) acciones.push('comprar');
      else if(j.basura>=tiendaObjetos[0].costo) acciones.push('comprar');
      if(usarCartaEspecial) acciones.push('usar_especial');
      let accionElegida = acciones[Math.floor(Math.random()*acciones.length)];
      if(accionElegida==='comprar'){ openStoreBot(j); setTimeout(()=>{siguienteTurno(); }, 1100); return;}
      cartaActual=pickRandomCarta();
      if(j.cartas.length>=maxCartasAlmacenadas) accionElegida='aplicar';
      if(accionElegida==='almacenar' && j.cartas.length<maxCartasAlmacenadas) j.cartas.push(cartaActual);
      else aplicarCartaBot();
      showTurnDialog(j.nombre+" hizo su jugada.");
      setTimeout(()=>{siguienteTurno();},1450);
    }
    function aplicarCartaBot(){
      let c = cartaActual;
      let j = jugadores[turnoActual];
      if (c.tipo==='basura') j.basura+=c.valor;
      if (c.descripcion==='Robo-Basura') {
        let victima = elegirVictimaBot();
        let vval = dado(6);
        jugadores[victima].basura = Math.max(0, jugadores[victima].basura-vval);
        j.basura += vval;
      }
      if (c.descripcion==='Hora de Pescar'){
        let idx=buscarMejorFicha();
        if(idx!==-1) {let f=fichas[idx]; f.revealed=true; j.fichas.push(f); j.puntaje+=f.valor; fichas.splice(idx,1);}
      }
      if (c.descripcion==='Intercambio de Ajolotes'){
        let victima=elegirVictimaBot();dueloIntercambioFichas(turnoActual,victima);
      }
      if (c.descripcion==='Duelo de Perder Turno') {
        let victima=elegirVictimaBot();dueloPerderTurno(turnoActual,victima);
      }
      if (c.descripcion==='Rotación de Basura'){rotarBasuraBot();}
      if (c.descripcion==='Cambio de Rotación de Turnos'){ sentidoGiro*=-1; }
    }
    function buscarMejorFicha(){
      let amarillo=fichas.findIndex(f=>f.color==='amarillo'&&!f.revealed);
      if(amarillo!==-1) return amarillo;
      let cafe=fichas.findIndex(f=>f.color==='café'&&!f.revealed);
      if(cafe!==-1) return cafe;
      return fichas.findIndex(f=>!f.revealed);
    }
    function elegirVictimaBot(){
      let otros=jugadores.map((j,i)=>i).filter(idx=>idx!==turnoActual);
      let lider=otros.reduce((a,b)=> jugadores[a].puntaje<jugadores[b].puntaje?b:a, otros[0]);
      return lider;
    }
    function dueloIntercambioFichas(a,b){
      let nA=dado(6), nB=dado(6);
      if (nA>nB&&jugadores[b].fichas.length){
        let f=jugadores[b].fichas.pop();jugadores[a].fichas.push(f);jugadores[a].puntaje+=f.valor;jugadores[b].puntaje-=f.valor;
      }
    }
    function dueloPerderTurno(a,b){
      let nA=dado(6), nB=dado(6);
      if (nA<nB) jugadores[a].turnosPerdidos++;
      else jugadores[b].turnosPerdidos++;
    }
    function rotarBasuraBot(){
      let arr=jugadores.map(j=>j.basura);
      for(let i=0;i<jugadores.length;i++) jugadores[i].basura=arr[(i+sentidoGiro+jugadores.length)%jugadores.length];
    }
    function openStoreBot(j){
      let robusto = tiendaObjetos.filter(o=>j.basura>=o.costo).pop();
      if(robusto){ j.basura-=robusto.costo;j.puntaje+=robusto.puntos;}
    }
    function pickRandomCarta(){ 
      if(cartasMain.length === 0) {
        cartasMain = shuffleArray([
          ...cartasBasura,...cartasBasura,...cartasEspeciales,...cartasEspeciales,
          ...cartasComodinReto,...cartasComodinEvento
        ]);
      }
      return cartasMain.shift();
    }
    function siguienteTurno(){
      turnosTotales++;
      checkFinJuego();
      if(!juegoEnCurso) return;
      turnoActual=(turnoActual+sentidoGiro+jugadores.length)%jugadores.length;
      doTurno();
    }
    function checkFinJuego(){
      if (fichas.length===0 || turnosTotales>=30){
        juegoEnCurso=false;
        mostrarRanking();
      }
    }
    function mostrarRanking(){
      document.getElementById('ranking').style.display='block';
      let ranking=jugadores.map(j=>({nombre:j.nombre,puntaje:j.puntaje})).sort((a,b)=>b.puntaje-a.puntaje);
      let html=""; ranking.forEach((j,i)=>{ html+= `<li><b>${i+1}. ${j.nombre}</b> — ${j.puntaje} puntos</li>`; });
      document.getElementById('rankingList').innerHTML=html;
    }

    // JUGADOR HUMANO Y CONTROLES
    document.getElementById('recogerCartaBtn').onclick=function(){
      clearTimeout(timerRef);
      cartaActual=pickRandomCarta();
      showTurnDialog("Sacaste: "+cartaActual.descripcion);
      document.getElementById('aplicarCartaBtn').style.display='inline-block';
      document.getElementById('almacenarCartaBtn').style.display='inline-block';
      document.getElementById('recogerCartaBtn').style.display='none';
      document.getElementById('finalizarTurnoBtn').style.display='inline-block';
      updateUI();
    };
    document.getElementById('aplicarCartaBtn').onclick=function(){ aplicarCartaHumano();};
    document.getElementById('almacenarCartaBtn').onclick=function(){
      let j=jugadores[turnoActual];
      if(j.cartas.length<maxCartasAlmacenadas) j.cartas.push(cartaActual);
      document.getElementById('aplicarCartaBtn').style.display='none';
      document.getElementById('almacenarCartaBtn').style.display='none';
      document.getElementById('finalizarTurnoBtn').style.display='inline-block';
      cartaActual = null;
      showTurnDialog("Carta almacenada. Presiona Finalizar Turno.");
      updateUI();
    };
    document.getElementById('finalizarTurnoBtn').onclick=function(){
      clearTimeout(timerRef);siguienteTurno();
    };
    document.getElementById('tiendaBtn').onclick=function(){openStore();};
    function usarCartaAlmacenada(idx){
      let j=jugadores[turnoActual];
      if(j.tipo!=='humano' || idx<0 || idx>=j.cartas.length) return;
      clearTimeout(timerRef);
      cartaActual = j.cartas[idx];
      j.cartas.splice(idx,1);
      showTurnDialog("Usaste: "+cartaActual.descripcion);
      updateUI();
      setTimeout(()=>{aplicarCartaHumano()}, 500);
    }
    function aplicarCartaHumano(){
      let c = cartaActual; 
      let j = jugadores[turnoActual];
      if (c.tipo==='basura'){ j.basura+=c.valor; showTurnDialog("+"+c.valor+" Basura"); }
      else if (c.descripcion==='Robo-Basura'){
        let victima=prompt("¿A quién le robas basura? (indica número 1-4)"); 
        victima=parseInt(victima)-1;
        if(isNaN(victima)||victima===turnoActual||victima<0||victima>=jugadores.length)
          victima=(turnoActual+1)%jugadores.length;
        let vval=dado(6);
        jugadores[victima].basura=Math.max(0,jugadores[victima].basura-vval);
        j.basura+=vval;
        showTurnDialog("¡Robaste "+vval+" basura!");
      }
      else if(c.descripcion==='Hora de Pescar'){
        abrirSeleccionFicha();
        return;
      }
      else if(c.descripcion==='Intercambio de Ajolotes'){
        let victima=parseInt(prompt("¿Con quién intercambias ajolotes? Indica número 1-4"),10)-1;
        if(isNaN(victima)||victima===turnoActual||victima<0||victima>=jugadores.length)
          victima=(turnoActual+1)%jugadores.length;
        dueloIntercambioFichas(turnoActual,victima);
        showTurnDialog("¡Intercambio realizado!");
      }
      else if(c.descripcion==='Duelo de Perder Turno'){
        let victima=parseInt(prompt("¿Contra quién duelo perder turno? Indica número 1-4"),10)-1;
        if(isNaN(victima)||victima===turnoActual||victima<0||victima>=jugadores.length)
          victima=(turnoActual+1)%jugadores.length;
        dueloPerderTurno(turnoActual,victima);
        showTurnDialog("¡Duelo de turnos!");
      }
      else if(c.descripcion==='Rotación de Basura'){
        rotarBasuraBot();showTurnDialog("¡Rotación de basura!");
      }
      else if(c.descripcion==='Cambio de Rotación de Turnos'){
        sentidoGiro*=-1;showTurnDialog("¡Rotación invertida!");
      }
      document.getElementById('aplicarCartaBtn').style.display='none';
      document.getElementById('almacenarCartaBtn').style.display='none';
      document.getElementById('finalizarTurnoBtn').style.display='inline-block';
      cartaActual = null;
      updateUI();
    }

    // MODAL FICHAS
    function abrirSeleccionFicha(){
      esperandoSeleccionFicha = true;
      fichaSeleccionadaIdx = null;
      document.getElementById('fichaSeleccionModal').style.display='flex';
      let fichasSelectRow = document.getElementById('fichasSelectModal');
      fichasSelectRow.innerHTML="";
      fichas.forEach((f,i)=>{
        let colorclass = f.revealed ? (f.color=='rosado'?'fichaRosa':(f.color=='café'?'fichaCafe':'fichaAmarilla')) : '';
        fichasSelectRow.innerHTML+= `<div class="ficha-circle ${colorclass}" id="fichaSelectable${i}" onclick="seleccionarFichaModal(${i})" style="cursor:pointer;">${f.revealed?f.valor:''}</div>`;
      });
    }
    function seleccionarFichaModal(idx){
      fichaSeleccionadaIdx = idx;
      for(let i=0; i<fichas.length; i++){
        let elem = document.getElementById('fichaSelectable'+i);
        if(elem) elem.classList.remove('ficha-selectable');
      }
      let elem = document.getElementById('fichaSelectable'+idx);
      if(elem) elem.classList.add('ficha-selectable');
    }
    function aceptarFichaSeleccionada(){
      if(fichaSeleccionadaIdx === null){
        alert('Debes seleccionar una ficha primero');
        return;
      }
      let j=jugadores[turnoActual];
      let f=fichas[fichaSeleccionadaIdx];
      f.revealed=true;
      j.fichas.push(f);
      j.puntaje+=f.valor;
      fichas.splice(fichaSeleccionadaIdx,1);
      cancelarSeleccionFicha();
      document.getElementById('finalizarTurnoBtn').style.display='inline-block';
      showTurnDialog("¡Pescaste una ficha "+f.color+" +"+f.valor+" puntos!");
      updateUI();
    }
    function cancelarSeleccionFicha(){
      esperandoSeleccionFicha = false;
      fichaSeleccionadaIdx = null;
      document.getElementById('fichaSeleccionModal').style.display='none';
      cartaActual = null;
    }

    // TIENDA
    function openStore(){
      clearTimeout(timerRef);
      document.getElementById('storeModal').style.display='flex';
      let items=document.getElementById('storeItems');
      let j=jugadores[turnoActual];
      items.innerHTML="";
      tiendaObjetos.forEach((obj,i)=>{
        let canBuy=j.basura>=obj.costo;
        items.innerHTML+= `<div class="store-item">
          <b>${obj.nombre}</b>
          <div class="store-item-desc">Costo: <strong>${obj.costo}</strong> basura</div>
          <div class="store-item-desc">Puntos: <strong>+${obj.puntos}</strong></div>
          <button class="btn btn-store" ${canBuy?'':'disabled'} onclick="buyStoreItem(${i})">Comprar</button>
        </div>`;
      });
    }
    function buyStoreItem(idx){
      let j=jugadores[turnoActual];
      let obj=tiendaObjetos[idx];
      if(j.basura>=obj.costo){ 
        j.basura-=obj.costo;
        j.puntaje+=obj.puntos;
        showTurnDialog(`¡Compraste ${obj.nombre}! +${obj.puntos} puntos`);
      }
      closeStore(); 
      siguienteTurno();
    }
    function closeStore(){ document.getElementById('storeModal').style.display='none'; }

    function sortTurnos(){
      let dados=jugadores.map(()=>dado(6));
      let max=dados.indexOf(Math.max(...dados));
      return max;
    }
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    function dado(n){
      return 1+Math.floor(Math.random()*n);
    }
  </script>
</body>
</html>
